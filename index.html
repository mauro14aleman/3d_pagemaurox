<script>
        // --- CONFIGURACIÓN DEL PDF ---
        const url = 'demo.pdf'; 
        let pdfDoc = null,
            pageNum = 1,
            pageIsRendering = false,
            pageNumPending = null;

        const scale = 1.2,
              canvas = document.querySelector('#pdf-render'),
              ctx = canvas.getContext('2d');

        // Renderizar página
        const renderPage = num => {
            pageIsRendering = true;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderCtx = { canvasContext: ctx, viewport };
                
                page.render(renderCtx).promise.then(() => {
                    pageIsRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
        };

        // Cargar documento
        pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
            pdfDoc = pdfDoc_;
            renderPage(pageNum);
        }).catch(err => {
            document.getElementById('status').innerText = "Error: No encuentro 'demo.pdf'";
        });

        const showPrevPage = () => { if (pageNum <= 1) return; pageNum--; renderPage(pageNum); };
        const showNextPage = () => { if (pageNum >= pdfDoc.numPages) return; pageNum++; renderPage(pageNum); };

        // --- CONFIGURACIÓN DE IA MEJORADA ---
        const video = document.getElementById("video");
        const status = document.getElementById("status");
        const videoContainer = document.querySelector('.video-container');
        let model = null;
        let lastActionTime = 0; 

        // 1. AJUSTE DE PRECISIÓN: Subimos el umbral a 0.85 (más estricto)
        const modelParams = {
            flipHorizontal: true,   
            maxNumBoxes: 1,         
            iouThreshold: 0.5,
            scoreThreshold: 0.85, 
        };

        // Dibujar las "Zonas" visualmente sobre el video para que el usuario sepa dónde tocar
        function drawZones() {
            // Creamos superposiciones visuales con CSS inyectado
            const leftZone = document.createElement('div');
            const rightZone = document.createElement('div');
            
            const styleBase = "position: absolute; top: 0; bottom: 0; opacity: 0.3; pointer-events: none;";
            leftZone.style = `${styleBase} left: 0; width: 20%; background: red; border-right: 2px solid red;`;
            rightZone.style = `${styleBase} right: 0; width: 20%; background: green; border-left: 2px solid green;`;
            
            videoContainer.appendChild(leftZone);
            videoContainer.appendChild(rightZone);
        }

        handTrack.load(modelParams).then(lmodel => {
            model = lmodel;
            status.innerText = "Cargando...";
            handTrack.startVideo(video).then(statusVideo => {
                if (statusVideo) {
                    status.innerText = "Sistema Listo. Toca los bordes de color.";
                    drawZones(); // Dibujamos las zonas
                    runDetection();
                } else {
                    status.innerText = "Activa la cámara.";
                }
            });
        });

        function runDetection() {
            model.detect(video).then(predictions => {
                if (predictions.length > 0) {
                    // Obtenemos el centro de la mano, no solo la esquina
                    const bbox = predictions[0].bbox; 
                    const x = bbox[0]; 
                    const w = bbox[2];
                    const handCenter = x + (w / 2); // Punto central de la mano

                    // Ancho del video (aprox 200px en el CSS)
                    const videoWidth = video.videoWidth || 200; 

                    const currentTime = new Date().getTime();
                    
                    // Lógica de espera (Cooldown) de 1.5 segundos
                    if (currentTime - lastActionTime > 1500) { 
                        
                        // 2. LÓGICA DE ZONAS ESTRICTAS
                        // Solo si la mano está en el 20% izquierdo
                        if (handCenter < videoWidth * 0.2) { 
                            status.innerText = "⏪ ANTERIOR";
                            status.style.background = "red";
                            status.style.color = "white";
                            showPrevPage();
                            lastActionTime = currentTime;
                        } 
                        // Solo si la mano está en el 20% derecho (más allá del 80%)
                        else if (handCenter > videoWidth * 0.8) { 
                            status.innerText = "SIGUIENTE ⏩";
                            status.style.background = "green";
                            status.style.color = "white";
                            showNextPage();
                            lastActionTime = currentTime;
                        } else {
                            // ZONA SEGURA (Centro)
                            status.innerText = "Zona Neutral (Mueve al borde para activar)";
                            status.style.background = "#ffcc00";
                            status.style.color = "black";
                        }
                    }
                }
                requestAnimationFrame(runDetection); 
            });
        }
    </script>
