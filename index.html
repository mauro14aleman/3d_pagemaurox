<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de PDF con Gestos</title>
    <script src="https://cdn.jsdelivr.net/npm/handtrackjs/dist/handtrack.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <style>
        body { font-family: sans-serif; background: #333; color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        #status { background: #ffcc00; color: black; padding: 5px 10px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; }
        
        /* Contenedor principal */
        .main-container { display: flex; gap: 20px; align-items: flex-start; }
        
        /* El lienzo del PDF */
        #pdf-render { border: 2px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-height: 80vh; }
        
        /* La cámara (la haremos pequeña para que no estorbe) */
        .video-container { width: 200px; border: 2px solid #00ff00; position: relative; }
        #video { width: 100%; height: auto; opacity: 0.8; }
        #canvas { display: none; } /* Lienzo interno de detección, lo ocultamos */
        
        .controls { margin-top: 10px; }
    </style>
</head>
<body>

    <h2>Control por Gestos: Mueve tu mano a los lados</h2>
    <div id="status">Cargando modelos... espera un momento.</div>

    <div class="main-container">
        <canvas id="pdf-render"></canvas>

        <div class="video-container">
            <video id="video"></video>
            <div style="text-align: center; font-size: 12px; color: #0f0;">Cámara de Control</div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DEL PDF ---
        const url = 'demo.pdf'; // ASEGÚRATE DE QUE TU ARCHIVO SE LLAME ASÍ
        let pdfDoc = null,
            pageNum = 1,
            pageIsRendering = false,
            pageNumPending = null;

        const scale = 1.2,
              canvas = document.querySelector('#pdf-render'),
              ctx = canvas.getContext('2d');

        // Renderizar página
        const renderPage = num => {
            pageIsRendering = true;
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderCtx = { canvasContext: ctx, viewport };
                
                page.render(renderCtx).promise.then(() => {
                    pageIsRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
        };

        // Cargar documento
        pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
            pdfDoc = pdfDoc_;
            renderPage(pageNum);
        }).catch(err => {
            document.getElementById('status').innerText = "Error: No encuentro 'demo.pdf'";
            console.error(err);
        });

        // Funciones de navegación
        const showPrevPage = () => { if (pageNum <= 1) return; pageNum--; renderPage(pageNum); };
        const showNextPage = () => { if (pageNum >= pdfDoc.numPages) return; pageNum++; renderPage(pageNum); };

        // --- CONFIGURACIÓN DE LA CÁMARA E IA ---
        const video = document.getElementById("video");
        const status = document.getElementById("status");
        let model = null;
        let lastActionTime = 0; // Para evitar pasar 10 páginas de golpe

        // Configuración de detección
        const modelParams = {
            flipHorizontal: true,   // Espejo para que sea natural
            maxNumBoxes: 1,         // Solo queremos ver una mano
            iouThreshold: 0.5,
            scoreThreshold: 0.7,
        };

        // Iniciar detección
        handTrack.load(modelParams).then(lmodel => {
            model = lmodel;
            status.innerText = "Modelo cargado. Encendiendo cámara...";
            handTrack.startVideo(video).then(statusVideo => {
                if (statusVideo) {
                    status.innerText = "¡Sistema Listo! Mueve tu mano.";
                    runDetection();
                } else {
                    status.innerText = "Por favor habilita la cámara.";
                }
            });
        });

        function runDetection() {
            model.detect(video).then(predictions => {
                // Si encontramos una mano
                if (predictions.length > 0) {
                    const mano = predictions[0].bbox; // [x, y, width, height]
                    const x = mano[0]; // Posición horizontal
                    
                    // Lógica simple: Izquierda o Derecha del video pequeño
                    // El video mide unos 200px de ancho aprox en el render interno
                    
                    const currentTime = new Date().getTime();
                    if (currentTime - lastActionTime > 1500) { // Esperar 1.5 segundos entre acciones
                        
                        if (x < 50) { // Mano muy a la izquierda
                            status.innerText = "DETECTADO: Anterior <<";
                            showPrevPage();
                            lastActionTime = currentTime;
                        } 
                        else if (x > 150) { // Mano muy a la derecha
                            status.innerText = "DETECTADO: Siguiente >>";
                            showNextPage();
                            lastActionTime = currentTime;
                        } else {
                            status.innerText = "Mano en el centro...";
                        }
                    }
                }
                requestAnimationFrame(runDetection); // Repetir el ciclo
            });
        }
    </script>
</body>
</html>
